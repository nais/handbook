{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"A handbook of sorts","text":"<p>Here we will cover the parts \"unique\" to us and therefore weren't covered during onboarding</p> <p> </p> <p>Nais is a complex animal - and if you are new to the team there will be quite a few things that are all but obvious and apparent.</p> <p>Factoids about the team are posted on Slack. Take a minute to present your facts, and find out about your colleagues.</p> <p>The technical documentation is comprehensive but hardly describes how we function as a team. This handbook is an attempt at bringing some of the silent knowledge to an audible frequency, and at the very least guide you through the bare essentials. To get you started we recommend that you familiarize yourself with our manifest. The guiding principles that define the how, the what, and the why we do the things that we do. </p> <p>So now that have you have memorized the manifest and documentation we can get into it all.</p>"},{"location":"administrative/areas/","title":"NAIS areas","text":"<p>To ensure that all parts of NAIS are well taken care of, we have created what we call \"areas\". Everything we create, have a home in one of these areas.  Each area has one or two anchors. The anchors responsibility is to ensure that the area is well taken care of. They have oversight over the area, and are the go-to person for questions and discussions related to the area. E.g. if a initiative is proposed that affects the area, the anchor should be involved in the discussion.</p> <p>NAIS is divided into several areas, each with its own anchor. The anchor is responsible for the area and is the go-to person for questions and discussions related to the area. The anchor is also responsible for keeping the area's board up to date.</p>"},{"location":"administrative/areas/#naisdevice","title":"naisdevice","text":"<p>Ankere: Vegar og Torbj\u00f8rn</p>"},{"location":"administrative/areas/#persistence","title":"Persistence","text":"<p>Anchor: Morten</p> <p>Components: DB, Kafka, Redis, OpenSearch, Bigquery, buckets</p> <p>Board: https://github.com/orgs/nais/projects/23/views/1</p>"},{"location":"administrative/areas/#deploy","title":"Deploy","text":"<p>Anchor: Kim Tore</p> <p>Components: hookd, naiserator, liberator, deploy-action</p>"},{"location":"administrative/areas/#auth","title":"Auth","text":"<p>Anchor: Trong</p> <p>Components: Digdirator, Azurerator, Wonderwall, TokenX, IAP / Forward Auth</p> <p>Board: https://github.com/orgs/nais/projects/27/views/1</p>"},{"location":"administrative/areas/#sarbarheter","title":"S\u00e5rbarheter","text":"<p>Ankere: Tommy og Youssef</p> <p>Components: SLSA, DependencyTrack, Picante, vulnerability scanning, Security Champion, supply chain security</p>"},{"location":"administrative/areas/#observability","title":"Observability","text":"<p>Anchor: Hans Kristian og Terje</p> <p>Components: Prometheus, Grafana, Alertmanager, Loki, Tempo, Fluentd/fluentbit, node_exporter, kube-state-metrics, OpenTelemetry</p>"},{"location":"administrative/areas/#cluster","title":"Cluster","text":"<p>Anchor: Sten</p> <p>Components: Nais-terraform-modules, nettverk(mesh, lb, peering), k8s </p>"},{"location":"administrative/areas/#nais-tooling","title":"NAIS Tooling","text":"<p>Anchor: Thomas og Christer</p> <p>Components: NAIS API, Console, NAIS CLI, Fasit</p>"},{"location":"administrative/areas/#nais-meta","title":"NAIS meta","text":"<p>Anchor: Frode, Johnny</p>"},{"location":"administrative/areas/#components-doc-naisio-handbook","title":"Components: doc, nais.io, handbook","text":"<p>Misc: - KrakenD: Tommy og Sindre - Unleash: Hans Kristian - Gemini: Kim Tore - Vault: Trong (https://github.com/orgs/nais/projects/26/views/1)</p>"},{"location":"administrative/fixtures/","title":"Fixtures","text":"<p>The NAIS team might look disorganised to a newcomer and in a certain sense of the word this holds true. However there are a few fixtures in place to ensure a certain degree of synchronisation, consensus and progression.</p>"},{"location":"administrative/fixtures/#froom","title":"Froom","text":"<p>Thanks to a pandemic, we have become \"remote first only\". And in case you are wondering; The froom is our zoom based digital workspace. Froom is a portmanteau of Frode and Zoom. Frode is a popular guy, so his personal Zoom space was where we all gravitated.</p> <p>We all hang out in the lobby and join breakout rooms for more in-depth exploration of topics that may not be of general interest. Anyone is welcome anywhere but \"good manners\" apply. Make your presence known when joining and if you sense that you will be interupting trains of thought or coding flow, come back later or use Slack instead. The froom url is posted in the topic here. </p> <p>All meeting fixtures are held in The froom as well as ad-hoc and sceduled meetings with third parties.</p> <p>Any and all meetings that are deemed unnecessary due to priority or lack of substance are swiftly cancelled and we all go back to [insert task].</p>"},{"location":"administrative/fixtures/#weekly","title":"Weekly","text":"<p>The NAIS weekly takes place Monday at high noon.</p>"},{"location":"administrative/slack/","title":"Slack","text":""},{"location":"administrative/slack/#we-do-not-want-to-leave-anyone-out-but-invites-and-inclusion-can-sometimes-fall-between-the-cracks","title":"We do not want to leave anyone out but invites and inclusion can sometimes fall between the cracks.","text":"<p>Here is a list of Slack channels you might want to join (or in some cases should be in). If you haven't been invited to a private channel listed here let your sponsor know.  </p>"},{"location":"administrative/slack/#private-channels","title":"Private Channels","text":"<p><code>#nais-internal</code> <code>#nais-tech</code></p>"},{"location":"administrative/slack/#public-channels","title":"Public Channels","text":"<p><code>#nais</code></p> <p><code>#naisdevice</code></p> <p><code>#nais-announcements</code></p>"},{"location":"administrative/nais-system/","title":"NAIS system","text":"<p>NAIS system is the name of the process we use to develop NAIS. </p> <p>The process a naisified version of Shape Up from 37signals, and has been used since the beginning of 2024. </p>"},{"location":"administrative/nais-system/#a-brief-overview","title":"A brief overview","text":"<p>We work in cycles. Each cycle consists of a six week focus period where we split into smaller groups, usually 2-3 people, working on one or more initiatives. </p> <p>After each focus period we have a two week cool-down. Here we reset, re-orient and make plans for what's next. </p> <p>Oh, and we also have holiday-modes in the summer and around Christmas.</p>"},{"location":"administrative/nais-system/#why-do-we-organize-our-work-this-way","title":"Why do we organize our work this way?","text":"<ul> <li>We value focus and deep work. We believe this leads to better solutions and happier team members. Having focus periods facilitates this. </li> <li>By basing our work on initiatives, we are forced to be explicit and clear about our ideas. This makes it possible for everyone to keep up with what's happening and take part in the discussions. Bonus: a finished initative along with it's discussions serves as an ADR.</li> <li>When working on an initiative, you don't have to start each day wondering what to do. Also, you know that what you are doing, makes sense. </li> <li>We belive that it creates a healthy commitment towards the rest of the team: namely that during the alotted time, you try to focus and do your best work. </li> <li>By organizing our work this way we achieve a shared orientation despite being a large team.</li> </ul>"},{"location":"administrative/nais-system/cycle/","title":"A NAIS cycle","text":""},{"location":"administrative/nais-system/cycle/#focus-period-6-weeks","title":"Focus period (6 weeks)","text":"<p>Every week during a focus period we have a weekly</p>"},{"location":"administrative/nais-system/cycle/#cool-down-2-weeks","title":"Cool-down (2 weeks)","text":"<ul> <li>Tuesday in the first week of a cooldown we have a NAIS day</li> <li>Cut-off for initiatives is the last day of the first week in cooldown. </li> <li>Thursday in the second week we announce the first draft of the next focus period. Any adjustments to the draft must be made by the end of the week.</li> </ul> <p>A calendar feed with the cycles can be found here</p>"},{"location":"administrative/nais-system/holiday-mode/","title":"Holiday modes","text":"<p>During the summer and around Christmas, we have what we call holiday modes. These are week-long periods without dedicated focus sessions, allowing us to self-organize and let work flow more organically. This approach accommodates vacation schedules and provides a refreshing change of pace.</p> <p>Some suggestions for what to do during holiday modes:</p> <ul> <li>Work on initiatives, or help out on the boards curated by the anchors. If you're unsure what to do you can ask the anchor of the area you're interested in.</li> <li>Work on stuff you've put off during focus periods.</li> <li>Write a blog post.</li> <li>Check with your team if there's something you can help out with.</li> </ul>"},{"location":"administrative/nais-system/initiatives/","title":"Initiative","text":"<p>The scheduled work we do in our focus periods are described in what we call initiatives.</p> <p>An initiative makes it clear why this should be done, and how it can solve what for whom. </p> <p>The process of taking an idea to a proposed initiative, is typically referred to as shaping.</p>"},{"location":"administrative/nais-system/initiatives/#anatomy","title":"Anatomy","text":"<p>These are the key components of an initiative:</p>"},{"location":"administrative/nais-system/initiatives/#essence","title":"Essence","text":"<p>The essence should describe the core idea and purpose of the initiative. This should be clear and concise, and ensures that you have solid understanding of the problem. </p> <p>In addition this helps the working group make scoping decisions along the way.</p>"},{"location":"administrative/nais-system/initiatives/#investment","title":"Investment","text":"<p>All iniatives are timeboxed to a certain number of weeks or days. This is the upper limit of how much time we are willing to spend on it, before we do a re-evaluation.</p> <p>It's important to note that this is not an estimate of how long it will take to complete the initiative, but rather a statement of how much time we feel is reasonable to spend on it given the potential impact.</p>"},{"location":"administrative/nais-system/initiatives/#non-goals","title":"Non-goals","text":"<p>During the shaping process, you often identify rabbit holes and critial paths that you don't want to go down. These should be listed as non-goals with an explanation.</p>"},{"location":"administrative/nais-system/initiatives/#possible-solution","title":"Possible solution","text":"<p>Make sure that there actually exists a path to success by sketching out how one envisions an actual possible solution. </p> <p>This exercise ensures that what is proposed is technically feasible. By going through the moving parts involved, you're usually able to detect any obvious show stoppers as well as possible rabbit holes to avoid. These should be listed as non-goals.</p> <p>Having worked through this, we can see if we are introducing or removing any components, creating any new dependencies or taking on any new responsibilities.  Understand the technical and/or human impact is important aspects when evaluating the initiative.</p> <p>If the solution impacts or involves some parts of NAIS, make sure that the relevant people (e.g. anchors) are involved in the shaping process.</p> <p>Rough sketches can also be helpful to help the working group understand the rough idea you have in mind.</p> <p>Depending on how clear your understanding of the problem is, this can be a chaotic process where many ideas are thrown around and you find yourself exploring many alternative solutions, refining the essence, and the investment as you go along. Note that the working group is free to deviate from this as long as the essence is preserved.</p>"},{"location":"administrative/nais-system/initiatives/#other-relevant-information","title":"Other relevant information","text":"<p>List any other relevant information that might be useful for the working group to know. Links, images, sketches, etc.</p>"},{"location":"administrative/nais-system/initiatives/#working-on-initiatives","title":"Working on initiatives","text":""},{"location":"administrative/nais-system/initiatives/#getting-started","title":"Getting started","text":"<p>When the focus period has been set, the working group get together and make a plan for the period.  It's a good idea to talk through the iniative(s) together, to make sure that everyone is on the same page. If anything is unclear, this is the time to ask questions and involve whomever was involved in the shaping of the initiative. Once this is done, it's a good idea to see if there is any particular order in which the initiatives should be worked on. </p> <p>Things to consider related to this might be: - Will any key people be unavailable during the focus period? - Are there any other initiatives in the team, that might impact our work - that we should coordinate with?</p>"},{"location":"administrative/nais-system/initiatives/#working-on-the-initiative","title":"Working on the initiative","text":"<p>When working on the iniatitive, it's important to keep track of time. Once in a while, it's good practice to check if we're on track to delivering the essence within the alloted time. </p> <p>You might find yourself in a situation where you've found a solution sooner than the scoped investment. This is normal and great, just move on. In the opposite situation, where more time is needed to finish the solution you've envisioned - see if there is a way to narrow the scope. If there isn't any meaningful way to reduce the scope, we re-evaluate the initiative before moving on.</p>"},{"location":"administrative/nais-system/nais-day/","title":"A NAIS day","text":"<p>Every Tuesday in the first week of the cooldown period is a NAIS day.</p> <p>On this particular Tuesday, those who can attend meet in person at the office.</p> <p>We start off the day with team discussions around how we work together as a team, and how we can improve.  We launch a thread in the #nais_internal channel a couple of days before to pre-populate our topics.</p> <p>This continues until lunch, followed by a group demo session to share our work from the last focus period. We discuss and share ideas until we feel just the right amount of dizzy. That's the signal that it's time to head off to a pub or restaurant for an evening of wining and dining. This is organized by our eminent social general, Kim Tore. </p>"},{"location":"administrative/nais-system/weekly/","title":"Weekly","text":"<p>The NAIS weekly takes place Mondays at high noon.</p>"},{"location":"social/the-great-outdoors/","title":"The Great Outdoors","text":""},{"location":"social/the-great-outdoors/#all-work-and-no-play-makes-nais-a-dull-platform","title":"\"All work and no play makes NAIS a dull platform\"","text":""},{"location":"social/the-great-outdoors/#native-naisians","title":"Native NAISians","text":""},{"location":"social/the-great-outdoors/#the-nais-pole","title":"The NAIS Pole","text":""},{"location":"technical/doc-guidelines/","title":"NAIS documentation guidelines","text":"<p>When writing the documentation we serve at doc.nais.io / <code>doc.&lt;tenant&gt;.cloud.nais.io</code>, we want to make sure that the content we provide helps our users to understand and use the platform we're making.</p> <p>Some key points to keep in mind when writing the docs are:</p> <ul> <li>Following the diataxis theory</li> <li>Less is more: Keep it short and to the point. This makes it easier to sustain high quality over time.</li> <li>We are writing docs for the users of our platform. No one else. We should be empathetic to their needs and understanding of the platform, and be mindful of adding details that are not relevant in the current documentation context</li> <li>Consistency in style and tone</li> <li>NAIS Quality</li> </ul>"},{"location":"technical/doc-guidelines/#structure","title":"Structure","text":"<p>We structure our content primarily around what services NAIS provide, with some honest exceptions.</p> <p>Under each service, or category of services, we use Diataxis with the following convention:</p> <p>The main page for a service is an Explanation of the service. It should give a high-level overview of what the service is, why you would use it, and how it fits into the NAIS ecosystem.</p> <p>Example structure:</p> <pre><code>some-service/\n\u251c\u2500 README.md # &lt;- explanation\n\u251c\u2500 how-to/\n\u2502  \u251c\u2500 verb.md\n\u251c\u2500 reference/\n\u2502  \u251c\u2500 spec.md\n\u251c\u2500 .pages\n</code></pre> Collapsed reference structure <p>If the service contains a single reference page, name the page <code>README.md</code>. This will collapse the directory structure in the navigation menu.</p>"},{"location":"technical/doc-guidelines/#honest-exceptions","title":"Honest exceptions","text":"<ul> <li>Top-level explanations</li> <li>Top-level tutorials</li> <li>Operate: Here we describe the tools and services that are used and required to operate the platform</li> <li>Tags overview</li> <li>Legal stuff</li> </ul>"},{"location":"technical/doc-guidelines/#pages-file","title":".pages file","text":"<p>The <code>.pages</code> file is used to define overrides and customizations to the titles and order of the pages in the navigation menu. This is a feature of the Awesome Pages plugin for MkDocs.</p> <p>A conventional <code>.pages</code> file looks like this:</p> .pages<pre><code>title: My overridden title\nnav:\n- README.md\n- \ud83d\udca1 Explanations: explanations\n- \ud83c\udfaf How-To: how-to\n- \ud83d\udcda Reference: reference\n- application\n- job\n- ...\n</code></pre>"},{"location":"technical/doc-guidelines/#conventions","title":"Conventions","text":""},{"location":"technical/doc-guidelines/#documentation-structure","title":"Documentation structure","text":"<p>The file tree represents the structure of the navigation menu. The H1 (#) will be the title of the page and the title in the navigation menu</p> <p>To override the placement in the navigation menu, we use the Awesome Pages plugin for MkDocs.</p>"},{"location":"technical/doc-guidelines/#placeholder-variables","title":"Placeholder variables","text":"<p>Where the reader is expected to change the content, we use placeholder variables. These variables are written in uppercase, with words separated by hyphens, surrounded by &lt;&gt;. For example: <code>&lt;MY-APP&gt;</code>.</p>"},{"location":"technical/doc-guidelines/#tenant-variables","title":"Tenant variables","text":"<p>We template the tenant name in the documentation using <code>&lt;&lt;tenant()&gt;&gt;</code> When the documentation is built, this will be replaced with the relevant tenant name.</p> <p>For even more convenience, we have a <code>&lt;&lt;tenant_url(\"service\")&gt;&gt;</code> function that will replace the <code>service</code> with the relevant URL for the service and create a full tenant URL to the service. An optional second parameter can be used to specify the path to the service eg. <code>&lt;&lt;tenant_url(\"grafana\", \"explore\")&gt;&gt;</code></p>"},{"location":"technical/doc-guidelines/#tenant-specific-content","title":"Tenant-specific content","text":"<p>Some sections are specific for a given tenant:</p> page.md<pre><code>{%- if tenant() == \"nav\" %}\nTenant-specific content\n{%- endif %}\n</code></pre> <p>...or for multiple tenants:</p> page.md<pre><code>{%- if tenant() in (\"nav\", \"dev-nais\") %}\nTenant-specific content\n{%- endif %}\n</code></pre>"},{"location":"technical/doc-guidelines/#tenant-specific-pages","title":"Tenant-specific pages","text":"<p>If an entire page is specific to a tenant, specify the <code>conditional</code> field in the markdown front matter:</p> page.md<pre><code>---\nconditional: [tenant, &lt;tenant-name&gt;]\n---\n\n# Title\n\n...\n</code></pre> <ul> <li><code>tenant</code> marks the page as tenant-specific.</li> <li><code>&lt;tenant-name&gt;</code> specifies which tenant that the page should be shown for.</li> </ul>"},{"location":"technical/doc-guidelines/#code-blocks","title":"Code blocks","text":"<p>When using code blocks, set the correct language for syntax highlighting. Define a title and highlight lines if needed.</p> page.md<pre><code>```yaml title=\"describe content / filename\" hl_lines=\"6-8 11\"\napiVersion: nais.io/v1alpha1\nkind: Application\n...\n```\n</code></pre>"},{"location":"technical/doc-guidelines/#alternate-paths","title":"Alternate paths","text":"<p>When the user is given a choice, we want to show both paths in the documentation. For example programming language, OS or different methods</p> page.md<pre><code>=== \"Linux\"\n\n  linux specific stuff\n\n=== \"macOS\"\n\n  macOS specific stuff\n</code></pre> <p>Indentation and blank lines</p> <p>Ensure you have tab indentation on the content block, as well as a blank line before and after.</p>"},{"location":"technical/doc-guidelines/#links","title":"Links","text":"<p>We want to make sure that the links are consistent and easy to understand. We use the following structure for links:</p> Type of Link Icon Link Explanation <code>[:bulb: Learn more about ...](../)</code> How-to guide <code>[:dart: Learn how to ...](../)</code> Reference <code>[:books: Reference for ](../)</code> Tutorial <code>[:rocket: Tutorial for ...](../)</code> External link <code>[:octicons-link-external-24: External link](https://...)</code> Prometheus <code>[:simple-prometheus: Open Prometheus](../)</code> Grafana <code>[:simple-grafana: Open Grafana](../)</code>"},{"location":"technical/doc-guidelines/#gcp-only-features","title":"GCP only features","text":"<p>Features that are only available in GCP clusters should preferably be marked in a consistent way.</p> <p>For that purpose, a macro is available to add a warning in the text:</p> page.md<pre><code># Aiven Redis\n\n&lt;&lt;gcp_only(\"Aiven Redis\")&gt;&gt;\n\nAiven Redis is ...\n</code></pre>"},{"location":"technical/doc-guidelines/#tags","title":"Tags","text":"<p>We use tags to categorize and group the content to make it easier to find, as an alternative to the navigation menu and search.</p> <p>Tags are written in the front matter of the markdown file like so:</p> page.md<pre><code>---\ntags: [tag1, tag2]\n---\n\n# Title\n\n...\n</code></pre>"},{"location":"technical/doc-guidelines/#which-tags-should-i-use","title":"Which tags should I use?","text":"<p>Tags should group multiple related pages together. Avoid using tags that only apply to a single page. This helps keeping the Tags-overview page cleaner.</p> <p>We typically always tag the diataxis-type the page classifies as with these mappings:</p> Form Tag Explanation <code>explanation</code> How-to guide <code>how-to</code> Reference <code>reference</code> Tutorial <code>tutorial</code> <p>Tag each page with the parent category or service that it belongs to.</p> <p>For example, these would be the tags for <code>metrics</code> and <code>tracing</code> in the <code>observability</code> category:</p> <pre><code>observability/\n\u251c\u2500 README.md           # tags: [observability, explanation]\n\u251c\u2500 metrics/\n\u2502  \u251c\u2500 README.md        # tags: [observability, metrics, explanation]\n\u2502  \u251c\u2500 how-to/\n|  |  \u251c\u2500 how-to1.md    # tags: [metrics, how-to]\n|  \u251c\u2500 reference/\n\u2502  |  \u251c\u2500 spec.md       # tags: [metrics, reference]\n\u251c\u2500 tracing/\n\u2502  \u251c\u2500 README.md        # tags: [observability, tracing, explanation]\n\u2502  \u251c\u2500 how-to/\n|  |  \u251c\u2500 how-to1.md    # tags: [tracing, how-to]\n|  \u251c\u2500 reference/\n\u2502  |  \u251c\u2500 spec.md       # tags: [tracing, reference]\n</code></pre>"},{"location":"technical/doc-guidelines/#diataxis-httpsdiataxisfr","title":"Diataxis (https://diataxis.fr/)","text":"<p>Di\u00e1taxis identifies four distinct needs, and four corresponding forms of documentation - tutorials, how-to guides, technical reference and explanation. It places them in a systematic relationship, and proposes that documentation should itself be organised around the structures of those needs.</p> <p>To create contents you must determine what you are setting out to do. Are you writing a Tutorial, a How-to guide, a Reference or is it a comprehensive Explanantion of a concept.</p>"},{"location":"technical/doc-guidelines/#tutorial","title":"Tutorial","text":"<p>A tutorial is an experience that takes place under the guidance of a tutor. A tutorial is always learning-oriented.</p>"},{"location":"technical/doc-guidelines/#how-to","title":"How-to","text":"<p>How-to guides are directions that guide the reader through a problem or towards a result. How-to guides are goal-oriented.</p>"},{"location":"technical/doc-guidelines/#reference","title":"Reference","text":"<p>Reference guides are technical descriptions of the machinery and how to operate it. Reference material is information-oriented.</p>"},{"location":"technical/doc-guidelines/#explanation","title":"Explanation","text":"<p>Explanation is a discusive treatment of a subject, that permits reflection. Explanation is understanding-oriented.</p>"},{"location":"technical/external-ingress/","title":"External ingress","text":"<p>We support adding external ingresses that other controls using cert-manager. This is easily done by adding a <code>CNAME</code> record pointing to an ingress we control.</p> <p>Read more about delegated domains for dns01 at cert-manager.io/docs.</p> <p>Underneath I've written the steps needed to take for us to get this working.</p>"},{"location":"technical/external-ingress/#getting-external-ingress-up-and-running","title":"Getting external ingress up and running","text":"<p>I'm going to use <code>detsombetyrnoe.no</code> as an example.</p> <ol> <li> <p>Ask the secops team to add a redirect from the domain to our external loadbalancer (prod-gcp: <code>34.102.211.240</code>).</p> </li> <li> <p>Ask the secops team do add the following <code>acme-challenge</code> to the domain:</p> <pre><code>_acme-challenge.detsombetyrnoe.no  IN  CNAME  _acme-challenge.detsombetyrnoe.inter.nav.no.\n</code></pre> </li> <li> <p>Create an Kubernetes <code>Issuer</code>:</p> <pre><code>apiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: detsombetyrnoe-no\n  namespace: nais-system\nspec:\n  acme:\n    email: frode.sundby@nav.no\n    preferredChain: ISRG Root X1\n    privateKeySecretRef:\n      name: cloud-nais-io-account-key\n    server: https://acme-v02.api.letsencrypt.org/directory\n    solvers:\n    - selector:\n        dnsZones:\n          - detsombetyrnoe.no\n      dns01:\n        cnameStrategy: Follow\n        cloudDNS:\n          hostedZoneName: intern-nav-no\n          project: nais-prod-020f\n</code></pre> <p>You can use <code>dnsName</code> if you don't have subdomains, or if you want to be explicit.</p> </li> <li> <p>Then create a Kubernetes <code>Certificate</code>:</p> <pre><code>apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: wc-detsombetyrnoe-no\n  namespace: nais-system\nspec:\n  dnsNames:\n  - detsombetyrnoe.no\n  - '*.detsombetyrnoe.no'\n  issuerRef:\n    name: detsombetyrnoe-no\n  secretName: wc-detsombetyrnoe-no-tls\n</code></pre> </li> <li> <p>After the certificate has been approved by Let's encrypt, you need to notify <code>loadbalancer</code> about your certificate secret <code>wc-detsombetyrnoe-no-tls</code>.    Go to Fasit &gt; Your env &gt; loadbalancer, and add your secret name to the <code>Certificates</code> list.</p> </li> <li>Then you need to inform <code>Naiserator</code> about the new ingress, <code>detsombetyrnoe.no</code>.    Go to Fasit &gt; Your env &gt; Naiserator, and add your secret name to the <code>Extra external hosts</code> list.</li> <li>Ask the user to add their new ingress to their <code>nais.yaml</code>.</li> <li>Success?</li> </ol>"},{"location":"technical/external-ingress/#subdomains-yeah-but-manually","title":"Subdomains? Yeah, but manually...","text":"<p>This solution also supports subdomains, but we need the secops team to add each subdomain as an <code>_acme_challenge</code>.</p> <pre><code>_acme-challenge.www.detsombetyrnoe.no\tIN\tCNAME\t_acme-challenge.detsombetyrnoe.intern.nav.no.\n</code></pre> <p>PS: Make sure there are not other issuer with the <code>tag: issuewild</code>!</p>"},{"location":"technical/external-ingress/#updating-manually-created-certificates","title":"Updating manually created certificates","text":"<p>Tenants with self-managed domains must manually update the certificates presented by the loadbalancers. These certificates  are stored in Google Certificate Manager. To upload new certficates from secrets in the cluster, the following command can be used: <pre><code># External loadbalancer certificates (globally managed)\n# For internal loadbalancer certificates add \"--location europe-north1\" to the command\ngcloud certificate-manager certificates create &lt;certificate name&gt; --private-key-file &lt;(kubectl get secret &lt;secretname&gt; -o json | jq -r '.data[\"tls.key\"]' |base64 -d) --certificate-file &lt;(kubectl get secret &lt;secret name&gt; -o json | jq -r '.data[\"tls.crt\"]' |base64 -d)\n</code></pre></p> <p>After the certificates are updated in Certificate Manager, nais-terraform-modules must be run to update the loadbalancers with the new certificates.</p>"},{"location":"technical/observability/","title":"Observability Stack","text":"<p>Sit back and relax, we got you covered. The observability stack in nais is designed to provide you with all the tools you need to monitor and troubleshoot your applications.</p>"},{"location":"technical/observability/#overview","title":"Overview","text":"<p>On a high level there are two parallel observability stacks in nais, one for nais-system namespaces (we call it the management stack) and one for tenant applications. Both stacks are based on the same components \u2013 Prometheus for metrics, Loki for logs, and Tempo for traces and Grafana for visualization.</p> <pre><code>---\nconfig:\n    flowchart:\n        defaultRenderer: elk\n---\n%%{init: {'theme':'dark'}}%%\n  flowchart\n    subgraph \"tenant\"\n      subgraph \"dev\"\n        prometheus-dev-nais[nais-system]\n        prometheus-dev-tenant[team apps]\n      end\n\n      subgraph \"prod\"\n        prometheus-prod-nais[nais-system]\n        prometheus-prod-tenant[team apps]\n      end\n\n      subgraph \"management\"\n        grafana-tenant[grafana.$tenant.cloud.nais.io] --&gt; prometheus-dev-tenant\n        grafana-tenant[grafana.$tenant.cloud.nais.io] --&gt; prometheus-prod-tenant\n        prometheus-management-nais[nais-system]\n      end\n    end\n\n    subgraph \"nais-io\"\n      grafana-nais-io[monitoring.nais.io] --&gt; prometheus-dev-nais\n      grafana-nais-io[monitoring.nais.io] --&gt; prometheus-prod-nais\n      grafana-nais-io[monitoring.nais.io] --&gt; prometheus-management-nais\n    end</code></pre> <p>The observability stack in nais consists of the following components:</p> <ul> <li> Prometheus Operator for managing Prometheus instances, providing easy monitoring definitions for Kubernetes services and deployment and management of Prometheus instances.</li> <li> Prometheus for metrics, offering powerful querying and alerting capabilities to monitor the performance and health of applications.</li> <li> Alertmanager for alerting, handling alerts sent by client applications such as the Prometheus server and managing silencing, inhibition, and alert grouping.</li> <li> Grafana for visualization, enabling the creation of dashboards and graphs to visualize metrics, logs, and traces from various data sources.</li> <li> Grafana Loki for logs, providing a highly efficient and cost-effective log aggregation system that integrates seamlessly with Grafana.</li> <li> Grafana Tempo for traces, offering a scalable and high-performance distributed tracing backend that integrates with Grafana for trace visualization.</li> <li> OpenTelemetry Collector for collecting, processing, and exporting telemetry data, supporting multiple formats and providing a vendor-agnostic solution for telemetry data management.</li> <li> Logging Operator for collecting logs from stdout/stderr, simplifying the deployment and management of Fluentd log collectors in Kubernetes environments.</li> </ul>"},{"location":"technical/observability/#opentelemetry-collector","title":"OpenTelemetry Collector","text":"<p>The OpenTelemetry Collector is a vendor-agnostic, open-source telemetry collector that can be used to collect, process, and export telemetry data. It is a powerful tool that can be used to collect logs, metrics, and traces from a variety of sources and export them to a variety of destinations.</p> <p>OpenTelemetry Collector implements the OpenTelemetry protocol (OTLP) which is a standard for transmitting telemetry data.</p> <p>We have two parallel OpenTelemetry Collectors running in nais, one for the management stack and one for tenant applications. The management collector is used to collect telemetry data from nais-system namespaces and the tenant collector is used to collect telemetry data from tenant applications.</p> <pre><code>---\nconfig:\n    flowchart:\n        defaultRenderer: elk\n---\n%%{init: {'theme':'dark'}}%%\n  flowchart\n    subgraph \"tenant\"\n      subgraph \"$env\"\n        subgraph \"$env-nais-system\" [nais-system]\n          $env-management-collector[Management Collector]\n\n          $env-otel-internet-collector[Internet Collector]\n          $env-otel-collector[Collector]\n          $env-tempo[Grafana Tempo]\n          $env-loki[Grafana Loki]\n          $env-prometheus[Prometheus]\n        end\n      end\n\n      subgraph \"management\"\n        subgraph \"nais-system\"\n          management-internet-collector[Internet Collector]\n          management-collector[Collector]\n          management-tempo[Grafana Tempo]\n          management-loki[Grafana Loki]\n          management-prometheus[Prometheus]\n        end\n      end\n    end\n\n    $env-otel-collector -- traces --&gt; $env-tempo\n    $env-otel-collector -- logs --&gt; $env-loki\n    $env-otel-collector -- metrics --&gt; $env-prometheus\n\n    management-collector -- traces --&gt; management-tempo\n    management-collector -- logs --&gt; management-loki\n    management-collector -- metrics --&gt; management-prometheus\n\n    naisdevice -- otlp --&gt; management-internet-collector\n    management-internet-collector -- otlp --&gt; management-collector\n\n    $env-management-collector -- otlp --&gt; management-collector\n\n    github[GitHub Actions] -- otlp --&gt; $env-otel-internet-collector</code></pre> Full otlpTraces only <p>Full otlp is used when all telemetry data is sent to the OpenTelemetry Collector including logs, metrics, and traces.</p> <pre><code>graph LR\n  Feature[Feature]\n  OtelCollector[Collector]\n  Loki\n  prometheus\n  Tempo\n\n  Feature -- otlp --&gt; OtelCollector\n\n  OtelCollector -- traces --&gt; Tempo\n  OtelCollector -- logs --&gt; Loki\n  OtelCollector -- metrics --&gt; prometheus\n\n  Tempo -- query --&gt; Grafana\n  Loki -- query --&gt; Grafana\n  prometheus -- query --&gt; Grafana</code></pre> <p>Traces only is used when only traces are sent to the OpenTelemetry Collector, logs are sent using stdout/stderr and metrics are scraped by Prometheus.</p> <pre><code>graph LR\n  Feature[Feature]\n  OtelCollector[Collector]\n  LoggingOperator\n  Loki\n  prometheus\n  Tempo\n\n  Feature -- traces --&gt; OtelCollector\n  Feature -- stdout/stderr --&gt; LoggingOperator\n  LoggingOperator -- forward --&gt; Loki\n  Feature -- scrape --&gt; prometheus\n  OtelCollector -- traces --&gt; Tempo\n\n  Tempo -- query --&gt; Grafana\n  Loki -- query --&gt; Grafana\n  prometheus -- query --&gt; Grafana</code></pre>"},{"location":"technical/observability/#endpoints","title":"Endpoints","text":"<p>The OpenTelemetry Collector exposes the following endpoints:</p> Endpoint Description <code>http://opentelemetry-management-collector:4317</code> Internal endpoint for features in nais-system namespace. <code>https://collector-internet.&lt;tenant&gt;.cloud.nais.io</code> Internet exposed endpoint for things running outside of nais. <p>Fasit features can use environment values in <code>Feature.yaml</code> to get the correct OpenTelemetry config without hardcoding the endpoint.</p> Feature.yaml <pre><code>values:\n  observability.otelp.endpoint:\n    computed:\n      template: \"{{ .Env.otel_otlp_endpoint }}\"\n  observability.otelp.protocol:\n    computed:\n      template: \"{{ .Env.otel_otlp_protocol }}\"\n  observability.otelp.insecure:\n    computed:\n      template: \"{{ .Env.otel_otlp_insecure }}\"\n</code></pre>"},{"location":"technical/observability/#tenant-clusters","title":"Tenant Clusters","text":"<p>All nais clusters have a dedicated OpenTelemetry Collector instance running in the <code>nais-system</code>. Tenant clusters forwards to management cluster using the <code>otlp-http</code> endpoint so that all telemetry data from nais-system is collected in a single place.</p> <pre><code>---\nconfig:\n    flowchart:\n        defaultRenderer: elk\n---\n%%{init: {'theme':'dark'}}%%\nflowchart\n  subgraph \"management\"[Management Cluster]\n    subgraph \"management-nais-system\"[nais-system]\n      OtelCollector[Management Collector]\n      Tempo\n      Loki\n      prometheus\n      Feature[Feature]\n    end\n  end\n\n  subgraph \"dev\"[Tenant Dev Cluster]\n    subgraph \"dev-nais-system\"[nais-system]\n      DevFeature[Feature]\n      DevOtelC[Management Collector]\n    end\n  end\n\n  subgraph \"prod\"[Tenant Prod Cluster]\n    subgraph \"prod-nais-system\"[nais-system]\n      ProdFeature[Feature]\n      ProdOtelC[Management Collector]\n    end\n  end\n\n  Feature -- otlp-grpc --&gt; OtelCollector\n\n  DevFeature -- otlp-grpc --&gt; DevOtelC\n  ProdFeature -- otlp-grpc --&gt; ProdOtelC\n  DevOtelC -- otlp-http --&gt; OtelCollector\n  ProdOtelC -- otlp-http --&gt; OtelCollector\n\n  OtelCollector -- traces --&gt; Tempo\n  OtelCollector -- logs --&gt; Loki\n  OtelCollector -- metrics --&gt; prometheus</code></pre>"},{"location":"technical/overview/","title":"NAIS Overview","text":"<p>This document is a high-level overview of the NAIS platform</p>"},{"location":"technical/overview/#namespaces","title":"Namespaces","text":"<p>Over the years we have a number of namespaces that we use for different purposes. The ones to know about are:</p> Name Description <code>nais-system</code> Where we deliver NAIS functionality <code>nais</code> Team namespace for NAIS. Custom functionality for NAV <code>nais-verification</code> Test applications for verifying NAIS with alerts <code>kyverno</code> Only Kyverno is allowed in here <code>cnrm-system</code> Where Cloud Native Resource Manager runs. Managed by Google"},{"location":"technical/overview/#tenants","title":"Tenants","text":""},{"location":"technical/overview/#clusters","title":"Clusters","text":""},{"location":"technical/overview/#management","title":"Management","text":""},{"location":"technical/production-ready/","title":"What is production ready?","text":"<p>This is the NAIS team's attempt to define what production ready means to us. Production implies quality and durability. Running a system means serving requests, and requests are ultimately serving users. We care about our users, thus we must care about our systems.</p> <p>At NAIS, we strive to:</p> <ul> <li>provide fully self serviced products with minimal downtime,</li> <li>be confident that code changes will not break existing functionality,</li> <li>respond quickly when systems fail,</li> <li>spend minimal time fixing errors,</li> <li>and most importantly: spend as much time possible implementing useful services for our users. (you!)</li> </ul> <p>We believe that if our systems conform to the principles in this document, we have a greater chance of achieving these goals.</p>"},{"location":"technical/production-ready/#12-factor-app","title":"12 factor app","text":"<p>Write your application according to the principles of 12 factor apps.</p> <p>Twelve factor apps:</p> <ul> <li>have declarative system requirements,</li> <li>are suitable for deployment in Docker containers,</li> <li>do not have differences between development and production, and</li> <li>can scale up without significant changes to tooling, architecture, or development practices.</li> </ul>"},{"location":"technical/production-ready/#observability","title":"Observability","text":"<p>Expose a Prometheus metric endpoint to allow scraping of key application metrics.</p>"},{"location":"technical/production-ready/#measuring-success","title":"Measuring success","text":"<p>Figure out service level indicators (SLI) and service level objectives (SLO).</p> <p>Service level indicators are quantifying metrics such as error rate, request latency, availability, and system throughput.</p> <p>Service level objectives are targets values for your metrics. You might say that you want an uptime of 99.9%. How do you define uptime? Is it a sufficiently low error rate? Is it being able to serve requests within a reasonable amount of time?</p> <p>Implement SLIs in the application code. Create views in a Grafana dashboard to check up on SLOs.</p> <p>Recommended read: Service Level Objectives in the Google Site Reliability Engineering handbook.</p>"},{"location":"technical/production-ready/#alerts","title":"Alerts","text":"<p>Alerts should be tied to SLOs. Consider if alerting is at all needed. An alert should only fire if human intervention is required. Too many alerts going off will result in alarm fatigue.</p>"},{"location":"technical/production-ready/#relevant-logs","title":"Relevant logs","text":"<p>Ensure traceability of errors by logging sufficient amount of debug information. Do not include sensitive data in logs. Sensitive data include credentials and personally identifyable information.</p>"},{"location":"technical/production-ready/#tests","title":"Tests","text":"<p>Ensure sufficient test coverage so that the next developer is not afraid of breaking things when updating your code.</p>"},{"location":"technical/production-ready/#documentation","title":"Documentation","text":"<ul> <li>Development/building</li> <li>End-user documentation</li> <li>Sysadmin/maintenance</li> <li>Document code where it is complex, hard to read, or otherwise obscure</li> </ul>"},{"location":"technical/production-ready/#continuous-integration","title":"Continuous Integration","text":"<p>Ensure that changes to the codebase are built automatically, and pushed to development and production environments. No manual steps other than <code>git push</code> should be neccessary.</p>"},{"location":"technical/production-ready/#publish-and-announce","title":"Publish and announce","text":"<p>Your system is not in production until it has users. Make sure all potential end users are aware of your system and can use it. Using a system means making requests and having access to support and documentation.</p>"},{"location":"technical/production-ready/#decrease-bus-factor","title":"Decrease bus factor","text":"<p>Ensure that at least two people on your team have sufficient knowledge to debug and work on the system, to avoid bus factor.</p>"},{"location":"technical/production-ready/#data-protection-impact-assessment","title":"Data Protection Impact Assessment","text":"<p>Perform, if applicable, a Data Protection Impact Assessment (or in Norwegian, personvernskonsekvensvurdering (PVK)).</p>"},{"location":"technical/production-ready/#security-audit","title":"Security Audit","text":"<p>Perform a security audit (ROS) before releasing to production.</p>"},{"location":"technical/publications-media/","title":"Publications &amp; Media","text":""},{"location":"technical/publications-media/#seasoned-adventurers-giving-back","title":"Seasoned adventurers - giving back","text":"<p>Our work is in large part driven by and on open source solutions and thanks to the sharing of others we enjoy a faster pace and more robust infrastructure than one might otherwise expect. With that in mind, we do try to contribute with content that describe topics and experiences that have been or are of significance. Being a public service we also try to share through talks, conferences and interactions with other government bodies and the developer community in general. Here is a collection of the past &amp; present.</p>"},{"location":"technical/publications-media/#write-ups","title":"Write ups","text":"<p>NAIS blog</p>"},{"location":"technical/publications-media/#presentations","title":"Presentations","text":"<ul> <li> <p>Using Kubernetes to Change Legacy Systems and Processes in the Public Sector </p> </li> <li> <p>Experiences From Running Istio in a K8s Production Environment </p> </li> <li> <p>NAIS applikasjonsplattform</p> </li> <li> <p>Continious Monitoring</p> </li> <li> <p>Hva kjennetegner en moderne applikasjonsplattform?</p> </li> </ul>"},{"location":"technical/upgrading-kafka/","title":"Procedure to follow when upgrading Kafka","text":"<p>Kafka is an important service in NAV, and problems that affect Kafka affects many teams. For that reason we have decided to describe the procedure for upgrading Kafka in detail, to have a playlist to refer to.</p> <p>The upgrade should be properly announced in #nais-announcements, with a copy to relevant channels, either by link or by copied text. For NAV, #kafka is a relevant channel. For any other tenants that use Kafka, the tenant will typically have one support channel which should get a copy of the announcement.</p>"},{"location":"technical/upgrading-kafka/#1-upgrade-in-dev-nais-dev-first","title":"1. Upgrade in dev-nais-dev first","text":"<p>The dev-nais tenant is our testing tenant, and allows testing platform changes without affecting developer teams. By upgrading in dev-nais-dev first, we can check that kafka-canary continues to work, and optionally run additional tests to verify that everything works.</p> <p>It is considered enough to check that the kafka-canary continues to work and handles the upgrade process without major issues.</p> <p>Once everything is confirmed to work in dev-nais-dev, rolling out to ci-nais should be next.</p> <p>Upgrading is done by changing <code>kafka_version</code> in the <code>naas.tf</code> file for dev-nais tenant, dev environment.</p>"},{"location":"technical/upgrading-kafka/#2-upgrade-the-ci-nais-tenant","title":"2. Upgrade the ci-nais tenant","text":"<p>The ci-nais tenant is our CI tenant, and should emulate a production tenant as close as possible. Upgrading in ci-nais will allow us to check that the upgrade process works in a tenant that is more similar to production.</p> <p>Once everything is confirmed to work in ci-nais, rolling out to other tenants/clusters should be started as soon as possible.</p> <p>Upgrading is done by changing <code>kafka_version</code> in the <code>naas.tf</code> file for ci-nais tenant, ci environment.</p>"},{"location":"technical/upgrading-kafka/#3-upgrade-development-environments","title":"3. Upgrade development environments","text":"<p>Currently, NAV is the only tenant that uses Kafka, but we have one project that fall in this category:</p> <ul> <li>nav-dev</li> </ul> <p>The upgrade should be announced clearly, with a request for teams to check their applications during the upgrade and after.</p> <p>Before starting the upgrade, it is recommended to silence some alerts that typically get triggered during the upgrade:</p> <ul> <li>HighDiskReads</li> <li>NetworkSentInbalanced</li> <li>HighDiskUsagePredicted</li> </ul> <p>After the upgrade, teams will have 1 week to report any issues to the nais-team, who can decide if the upgrade in production should be held back or go ahead.</p> <p>Upgrading is done by changing/adding <code>kafka_version</code> in the <code>naas.tf</code> file for nav tenant, dev-gcp environment.</p>"},{"location":"technical/upgrading-kafka/#4-upgrade-remaining-environments","title":"4. Upgrade remaining environments","text":"<p>When announcing the upgrade, request that teams that haven't checked their dev environment do so now, and allow for a few hours before starting the upgrade. Make sure to dedicate time to watch the upgrade progress, and follow up on any reports of problems.</p> <p>Before starting the upgrade, it is recommended to silence some alerts that typically get triggered during the upgrade:</p> <ul> <li>HighDiskReads</li> <li>NetworkSentInbalanced</li> <li>HighDiskUsagePredicted</li> <li>HighDiskWrites</li> <li>TODO: Find links for alerts in nav-infrastructure</li> </ul> <p>Make sure to inform the users when the upgrade has completed.</p> <p>Upgrading is done by changing the default value for the <code>kafka_version</code> variable in these files (and remove any tenant/environment specific values):</p> <ul> <li>modules/aiven/variables.tf</li> <li>modules/legacy/variables.tf</li> <li>modules/tenant/variables.tf</li> </ul>"},{"location":"technical/narcos/","title":"Narcos","text":"<p>NAIS Adminstrator CLI Og Scripts</p>"},{"location":"technical/narcos/#installation","title":"Installation","text":"<p><code>brew install narco</code></p>"},{"location":"technical/narcos/#usage","title":"Usage","text":"<p>See available subcommands under the Reference section in the navigation sidebar.</p>"},{"location":"technical/narcos/reference/cluster/","title":"cluster command","text":"<p>The <code>cluster</code> command let you generate <code>kubeconfig</code>, and <code>list</code> clusters available for you.</p>"},{"location":"technical/narcos/reference/cluster/#kubeconfig","title":"kubeconfig","text":"<p>Create a kubeconfig file for connecting to available clusters for you. This requires that you have the gcloud command line tool installed, configured and logged in. You can log in with <code>gcloud auth login --update-adc</code>.</p> <pre><code>narc kubeconfig\n</code></pre> Flag Short Description overwrite Overwrite config already in the kubeconfig-file clean Delete config before retrieving new one verbose -v More output, mostly useful combined with overwrite"},{"location":"technical/narcos/reference/cluster/#list","title":"list","text":"<p>List clusters available.</p> <pre><code>narc cluster list\n</code></pre>"},{"location":"technical/narcos/reference/tenant/","title":"tenant command","text":"<p>The <code>tenant</code> command let you <code>list</code>, <code>get</code>, and <code>set</code> tenant for your Naisdevice.</p>"},{"location":"technical/narcos/reference/tenant/#list","title":"list","text":"<p>List tenants available.</p> <pre><code>narc tenant list\n</code></pre>"},{"location":"technical/narcos/reference/tenant/#get","title":"get","text":"<p>Get your current tenant.</p> <pre><code>narc tenant get\n</code></pre>"},{"location":"technical/narcos/reference/tenant/#set","title":"set","text":"<p>Switches your tenant to the one specified. May require that you log in.</p> <pre><code>narc tenant set TENANT\n</code></pre>"},{"location":"technical/tenant-setup/","title":"Setting up a tenant organization","text":"<p>TODO:</p> <ul> <li>nais-terraform-modules, legg til ny tenant i lista i serviceaccounts.tf. -&gt; PR -&gt; apply</li> <li>add denne brukeren til billing i NAV (frode, sten og johnny kan gj\u00f8re dette). Billing -&gt; Account Management -&gt; se p\u00e5 h\u00f8yresida -&gt; Add user.</li> <li>for nytt domene: bestilles av Trond. N\u00e5r det er klart, kan man klikke seg igjennom og opprette ny org. Da m\u00e5 det verifiseres noe greier som m\u00e5 inn i DNS.</li> </ul> <p>This guide is used when setting up a new tenant. This is typically done by the NAIS team, together with the tenants administrators.</p> <pre><code>graph TD\nA[Google Tenant] --&gt; B[NAIS Folder]\nB --&gt; C[management]\nB --&gt; D[dev]\nB --&gt; E[prod]</code></pre>"},{"location":"technical/tenant-setup/#prereq","title":"Prereq","text":"<ul> <li>Google Cloud Tenant admin</li> <li>GitHub Organization</li> <li>Allow users from nais.io (nais-io) in the <code>Allowed Domain Policy</code> under <code>IAM/Organization Policies</code></li> </ul>"},{"location":"technical/tenant-setup/#required-settings","title":"Required settings","text":""},{"location":"technical/tenant-setup/#required-permissions","title":"Required permissions","text":"<p>On the user that will run the following commands, the following IAM roles are required on an organization level.</p> <ul> <li><code>Owner</code></li> <li><code>Organization Administrator</code></li> <li><code>Folder Creator</code></li> <li><code>Organization Policy Administrator</code></li> </ul>"},{"location":"technical/tenant-setup/#create-the-nais-folder","title":"Create the NAIS folder","text":"<p>Everything related to NAIS is contained within this folder.</p> <pre><code>export NAAS_ORG_NAME=my-org # (1)\nexport NAAS_ORG_ID=$(gcloud organizations list --filter $NAAS_ORG_NAME --format \"value(name)\")\n\ngcloud organizations add-iam-policy-binding \"$NAAS_ORG_ID\" --member=\"domain:nais.io\" --role=\"roles/compute.osLoginExternalUser\"\ngcloud resource-manager folders create --display-name=nais --organization=$NAAS_ORG_ID\nexport NAAS_GOOGLE_FOLDERID=$(gcloud resource-manager folders list --organization=\"$NAAS_ORG_ID\" --filter \"displayName=nais AND parent=organizations/${NAAS_ORG_ID}\" --format \"value(name)\")\n</code></pre> <ol> <li> Change this to the name of your Google Organization</li> </ol>"},{"location":"technical/tenant-setup/#grant-access-to-the-nais-team-and-the-terraform-user","title":"Grant access to the NAIS team and the terraform user","text":"<p>To allow the NAIS team the required permissions to operate nais, IAM policies must be added to the NAIS folder.</p> <p>Bug</p> <p>Find correct roles for the following users:</p> <ul> <li>nais-viewers</li> <li>nais-admins</li> </ul> Copy and run this command <pre><code>cat &lt;&lt;EOF &gt; naas-google-org-policy.json\n{\n  \"bindings\": [\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/artifactregistry.admin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/compute.admin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/container.admin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/dns.admin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/logging.admin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/resourcemanager.folderCreator\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/resourcemanager.folderIamAdmin\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/resourcemanager.projectCreator\"\n    },\n    {\n      \"members\": [\n        \"serviceAccount:nais-tf-__TENANTNAME__@nais-io.iam.gserviceaccount.com\"\n      ],\n      \"role\": \"roles/serviceusage.serviceUsageAdmin\"\n    }\n  ]\n}\nEOF\nread -p \"Enter NaaS Tenant Name [$NAAS_TENANTNAME]: \" TENANTNAME &amp;&amp; \\\nexport NAAS_TENANTNAME=\"${TENANTNAME:-$NAAS_TENANTNAME}\" &amp;&amp; \\\nsed -ie \"s/__TENANTNAME__/$NAAS_TENANTNAME/g\" naas-google-org-policy.json &amp;&amp; \\\necho \"gcloud resource-manager folders set-iam-policy $NAAS_GOOGLE_FOLDERID naas-google-org-policy.json\"\n</code></pre>"},{"location":"technical/tenant-setup/#run-nais-terraform-modules","title":"Run nais-terraform-modules","text":"<p>Before doing the following step, run the terraform setup. but even before this again, update nais/core/ipplan</p>"},{"location":"technical/tenant-setup/#teams-and-users","title":"Teams and users","text":""},{"location":"technical/tenant-setup/#create-nais-admin-user-in-tenant-admingooglecom","title":"Create nais admin user (in tenant admin.google.com)","text":"<p>Nais needs a dedicated user account in the Google directory. This user must be manually created in the Google Admin console. The user must be granted the <code>Groups Admin</code> role to be able to create and maintain groups for the teams:</p> <ol> <li>Go to https://admin.google.com/ac/users</li> <li>Click on <code>Add new user</code></li> <li>Enter <code>nais</code> as first name, and <code>admin</code> as last name</li> <li>Enter <code>nais-admin</code> as the primary email</li> <li>Click <code>Add new user</code> to add the user account (you can safely ignore the generated password)</li> <li>Click on the created user (might require a hard refresh of the user list) and then on <code>Assign roles</code> under the <code>Admin roles and privileges</code> section</li> <li>Assign the <code>Groups Admin</code> role and click <code>Save</code></li> </ol>"},{"location":"technical/tenant-setup/#set-up-domain-wide-delegation-in-tenant-admingooglecom","title":"Set up domain-wide delegation (in tenant admin.google.com)","text":"<p>Nais performs some operations on behalf of the Nais admin user mentioned above. For this to work the, this user needs domain-wide delegation with some scopes. This must be manually set up in the Google Admin console:</p> <ol> <li>Go to https://admin.google.com/ac/owl/domainwidedelegation</li> <li>Click on <code>Add new</code> to add a new Client ID</li> <li>Enter the ID of the tenant directory service account     Using gcloud<pre><code>MANAGEMENT_PROJECT_ID=&lt;tenant management project&gt;\ngcloud iam service-accounts --project=$MANAGEMENT_PROJECT_ID describe tenant-directory-sa@$MANAGEMENT_PROJECT_ID.iam.gserviceaccount.com --format=\"value(uniqueId)\"\n</code></pre></li> <li>Add the following scopes:<ul> <li><code>https://www.googleapis.com/auth/admin.directory.group</code></li> <li><code>https://www.googleapis.com/auth/admin.directory.user.readonly</code></li> </ul> </li> <li>Click on <code>Authorize</code></li> </ol> <p>After this is done you should see something like the following:</p> <p></p>"},{"location":"technical/tenant-setup/#create-console-admins-group-in-tenant-admingooglecom","title":"Create Console admins group (in tenant admin.google.com)","text":"<p>Nais (API) automatically syncs users from the Google Workspace to its own database. Tenants can control which users that should be assigned the admin role in Nais by creating a group called <code>console-admins@&lt;tenant-domain&gt;</code>, and then add the necessary users to this group. When Console/Nais API runs the user sync it will look for this group, and make sure that the users in the group are granted the admin role. Whenever a user is removed from the group, Nais will revoke the admin role from the user on the next sync.</p> <ol> <li>Go to https://admin.google.com/ac/groups</li> <li>Click on <code>Create group</code></li> <li>Enter <code>console-admins</code> as the group name</li> <li>Enter <code>console-admins</code> as the email address</li> <li>Enter <code>This group is used to control who has admin permissions in the Nais Console</code> as the description</li> <li>Click <code>Next</code></li> <li>Select 'Only invited users' in the 'Who can join the group' section. Leave the rest as default.</li> <li>Click <code>Create Group</code></li> </ol> <p>Users with the admin role in Console have access to some additional settings:</p> <ul> <li>Configure / enable / disable reconcilers</li> <li>Grant / revoke roles</li> <li>Manipulate reconciler states for teams</li> </ul>"},{"location":"technical/tenant-setup/#create-kubernetes-security-group-in-tenant-admingooglecom","title":"Create Kubernetes security group (in tenant admin.google.com)","text":"<p>This group is used to manage access to the kubernetes clusters, and this is where Nais automatically adds teams that should have access to the clusters.</p> <p>In Google Admin create a group named <code>gke-security-groups</code>. Make sure the group has the View Members permission selected for Group Members.</p>"},{"location":"technical/tenant-setup/#create-nais-k8s-nais-admin-groups-do-not-confuse-with-the-tenants-nais-admins-group-above-done-in-naisio-admingooglecom","title":"Create nais' k8s nais admin groups (do not confuse with the tenants nais-admins group above, done in nais.io admin.google.com)","text":"<p>Create group $NAAS_TENANT_NAME-k8s-admins with the email: $NAAS_TENANT_NAME-k8s-admins@nais.io</p>"},{"location":"technical/tenant-setup/#configure-oauth-login-for-web-frontend","title":"Configure OAuth login for web frontend","text":"<p>Set up an OAuth client for Console.</p> <ol> <li>Go to https://console.cloud.google.com</li> <li>Choose project  -&gt; nais-management -&gt; nais-management <li>Go to APIs ans Service -&gt; OAuth consent screen</li> <li>Internal -&gt; create</li> <li>App name: <code>nais management</code></li> <li>User support email: <code>admin@&lt;tenant-domain&gt;</code></li> <li>Developer Contact email: <code>admin@&lt;tenant-domain&gt;</code></li> <li>Save and continue (x2)</li> <li>Go to APIs ans Service -&gt; Credentials</li> <li>Click Create Credentials -&gt; OAuth client ID</li> <li>Select type Web Application</li> <li>Name: <code>Console</code></li> <li>Authorized redirect URI: <code>http://console.&lt;tenant-name&gt;.cloud.nais.io/oauth2/callback</code></li> <li>Set Name and Authorized redirect URIs</li> <li>Create</li> <li>Copy client id and secret and give to NAIS-team</li>"},{"location":"technical/tenant-setup/#highly-recommended-settings","title":"Highly recommended settings","text":""},{"location":"technical/tenant-setup/#log-location","title":"Log location","text":"<p>Every project created in GCP will have a default log location for all logs. The default is Global. In order to keep your logs in europe, we strongly recommend setting the default log location to europe using the following command</p> <pre><code>gcloud alpha logging settings update --organization=$NAAS_ORG_ID --storage-location=europe-north1\n</code></pre>"},{"location":"technical/tenant-setup/#organization-policy-for-location","title":"Organization policy for location","text":"<p>Although all resources created by NAIS is located within the EU, teams are still able to create resources anywhere unless an organizational constraint is in place.</p> Click to see file content <pre><code>constraint: constraints/gcp.resourceLocations\netag: BwVUSr8Q7Ng=\nlistPolicy:\n  allowedValues:\n  - in:eu-locations\n</code></pre> <pre><code>gcloud beta resource-manager org-policies set-policy --organization=$NAAS_ORG_ID &lt;file name&gt;.yaml\n</code></pre>"},{"location":"technical/tenant-setup/#github-actions-secrets","title":"Github Actions secrets","text":"<p>If you are using Github Actions to deploy your applications, you may want to add the following variable and secret to your organization's Github Actions secrets:</p> <p>Open <code>https://github.com/organizations/[ORG_NAME]/settings/secrets/actions</code></p> Name Type <code>NAIS_MANAGEMENT_PROJECT_ID</code> <code>Variable</code> <code>NAIS_WORKLOAD_IDENTITY_PROVIDER</code> <code>Secret</code> <p>These may also be set in the repository's secrets, but it is recommended to set them in the organization's secrets as they are shared between all teams.</p> <p>The NAIS team will provide the values.</p>"},{"location":"technical/tenant-setup/addons/aiven/","title":"Aiven services and Kafka","text":"<p>Aiven is a third party service provider that nais uses for some of the features we provide. If the tenant wishes to use some of those features, Aiven needs to be enabled for the tenant. The tenant does not need to have any interaction with Aiven directly, but the NAIS team will need to set up the necessary resources.</p> <p>Aiven provides these services:</p> <ul> <li>Kafka (one per tenant environment)</li> <li>OpenSearch (Created on-demand for each application)</li> <li>Redis (Created on-demand for each application)</li> </ul> <p>This is an optional feature that is not enabled by default.</p>"},{"location":"technical/tenant-setup/addons/aiven/#for-tenant","title":"For Tenant","text":""},{"location":"technical/tenant-setup/addons/aiven/#requirements-and-setup","title":"Requirements and Setup","text":"<p>No preparation is required from the tenant.</p>"},{"location":"technical/tenant-setup/addons/aiven/#usage-by-applications","title":"Usage by Applications","text":"<p>Applications that wishes to use Kafka must configure the application:</p> <pre><code>spec:\n  kafka:\n    pool: &lt;tenant&gt;-&lt;environment&gt;\n</code></pre> <p>Relevant documentation for applications:</p> <ul> <li>Kafka</li> <li>OpenSearch</li> <li>Redis</li> </ul>"},{"location":"technical/tenant-setup/addons/aiven/#for-nais","title":"For NAIS","text":"<ul> <li>Enable Aiven for the tenant in nais-terraform-modules</li> <li> <p>If the tenant wishes to use Kafka, enable Kafka in nais-terraform-modules</p> </li> <li> <p>After terraform has created the necessary Aiven resources, enable relevant features in Fasit    (including required dependencies):</p> <ul> <li><code>aiven-operator</code></li> <li><code>mutilator</code></li> <li><code>aivenator</code></li> </ul> </li> <li> <p>If Kafka is enabled, also enable these features:</p> <ul> <li><code>kafka-canary</code><ul> <li>In management environment</li> </ul> </li> <li><code>kafkarator</code></li> <li><code>aiven-alerts</code></li> <li><code>kafka-canary-alert</code></li> <li><code>kafka-lag-exporter</code></li> </ul> </li> </ul>"},{"location":"technical/tenant-setup/addons/azure-ad/","title":"Azure AD","text":"<p> nais/azurerator creates and manages Azure AD applications via Kubernetes Custom Resources for use in various authentication scenarios.</p> <p>This is an optional addon in NaaS. It is not enabled by default.</p>"},{"location":"technical/tenant-setup/addons/azure-ad/#for-tenant","title":"For Tenant","text":""},{"location":"technical/tenant-setup/addons/azure-ad/#requirements","title":"Requirements","text":"<p>To be able to use this addon, you will need to bring your own Azure AD tenant.</p> <p>Unfortunately, we do not offer provisioning nor management of Azure AD itself as a service. The Azure AD tenant must be wholly owned and operated by your organization.</p> <p>You will also need to set up a couple of things within said tenant. We'll guide you through the steps.</p>"},{"location":"technical/tenant-setup/addons/azure-ad/#google-service-accounts","title":"Google Service Accounts","text":"<p>Azurerator uses federated credentials in order to authenticate itself to your Azure AD tenant, by using tokens issued by Google.  This removes the need to share client secrets between our organizations. The tokens are in turn only issued to Google Service Accounts that exist within the NAIS projects that we've created for your Google organization.</p> <p>To set this up, you will need to find some identifiers from within your Google organization:</p> <ol> <li>Find the NAIS Google Project IDs:<ol> <li>Use the <code>gcloud</code> CLI: <code>gcloud projects list --filter=\"nais-\"</code></li> <li>There should be one project ID for each environment; <code>nais-dev-xxxx</code> and <code>nais-prod-xxxx</code>. Note these down.</li> </ol> </li> <li>For each project ID, find the unique Service Account ID for Azurerator:<ol> <li><code>gcloud iam service-accounts describe azurerator@&lt;PROJECT_ID&gt;.iam.gserviceaccount.com</code>, where <code>PROJECT_ID</code> is the ID found in the previous step.</li> <li>Note down the <code>uniqueId</code> for the service account. This ID uniquely identifies the Google Service Account that Azurerator uses in each environment.</li> </ol> </li> </ol>"},{"location":"technical/tenant-setup/addons/azure-ad/#azure-ad-application-registration","title":"Azure AD Application Registration","text":"<p>An Azure AD application registration within the tenant mentioned above is needed for Azurerator to create and manage application registrations within Azure AD.</p> <ol> <li>Sign in to your Azure Account through the Azure portal.</li> <li>Select Azure Active Directory.</li> <li>Select App registrations.</li> <li>Select New registration.<ol> <li>Name the application, for example \"azurerator\".</li> <li>Supported account type doesn't matter, single tenant is fine. </li> <li>Leave Redirect URI empty.</li> </ol> </li> <li>Under Overview, note down the values for the following fields:<ol> <li>Application (client) ID.</li> <li>Directory (tenant) ID</li> </ol> </li> <li>Navigate to Certificates and secrets.<ol> <li>Select Federated credentials.</li> <li>Select Add credentials.</li> <li>Under Federated credential scenario, select Other issuer.</li> <li>Under Issuer, enter the value <code>https://accounts.google.com</code></li> <li>Under Subject, enter the value for <code>uniqueId</code> that you noted down from the previous section on Google Service Accounts.</li> <li>Under Name, enter the value <code>nais-&lt;environment&gt;</code>, for example <code>nais-dev</code> or <code>nais-prod</code></li> <li>Leave the Audience at the default value, i.e. <code>api://AzureADTokenExchange</code></li> <li>Repeat the steps starting from step 6 with the second <code>uniqueId</code> from the previous section on Google Service Accounts.</li> </ol> </li> <li> <p>Navigate to API permissions.</p> <ol> <li>Select Add a permission.</li> <li>Select Microsoft Graph.</li> <li>Select Application permissions.</li> <li>The application needs the following permissions:<ul> <li><code>Application.ReadWrite.All</code></li> <li><code>DelegatedPermissionGrant.ReadWrite.All</code></li> <li><code>GroupMember.Read.All</code></li> </ul> </li> <li>Add the permissions.</li> <li>Select Grant admin consent for &lt;tenant name&gt;.</li> <li>Confirm to grant the application access to the configured permissions.</li> </ol> <p>If done correctly, the list of permissions should look like this:</p> <p></p> </li> </ol>"},{"location":"technical/tenant-setup/addons/azure-ad/#microsoft-graph-object-id","title":"Microsoft Graph Object ID","text":"<p>In order for Azurerator to pre-approve delegated API permissions for the managed applications, you will need to find the Object ID for the Microsoft Graph Enterprise Application that is unique to each Azure AD tenant.</p> <ol> <li>Sign in to your Azure Account through the Azure portal.</li> <li>Select Azure Active Directory.</li> <li>Select Enterprise applications.</li> <li>Filter the list of applications:<ol> <li>Applicaton ID starts with == \"00000003-0000-0000-c000-000000000000\"</li> <li>Application type == \"Microsoft Applications\"</li> </ol> </li> <li>You should see an application named <code>GraphAggregatorService</code> or <code>Microsoft Graph</code>.</li> <li>Note down the Object ID for this application.</li> </ol>"},{"location":"technical/tenant-setup/addons/azure-ad/#application-access-groups","title":"Application Access Groups","text":"<p>Azurerator creates Azure AD application registrations that are restricted by default:</p> <ul> <li>Users are not allowed access to the application unless they are explicitly given access.</li> <li>Access is granted by group membership; groups are assigned directly to applications.</li> <li>Users must be direct members of the groups, i.e. nested groups will not work.</li> </ul> <p>You will need to define a group that contains all users in your tenant.  The definition of \"all users\" is left for you to decide. This can for example be:</p> <ul> <li>all users, including guest accounts and machine users</li> <li>all users that are not guests in your tenant</li> <li>all users that have a valid license</li> <li>all users within a certain department, and so on</li> </ul> <p>Refer to the following guides at Microsoft for details on groups:</p> <ul> <li>creating and managing groups </li> <li>dynamic group memberships</li> </ul> <p>The all users group will be assigned to any application that has enabled the <code>allowAllUsers</code> directive.  Note down the object ID for this group.</p> <p>Once you've got through all of the above, provide the NAIS team with the following information:</p> Property Description Tenant ID See Azure AD Application Registration Client ID See Azure AD Application Registration Microsoft Graph Object ID See Microsoft Graph Object ID Default All-Users Group Object ID See Application Access Groups"},{"location":"technical/tenant-setup/addons/azure-ad/#for-nais","title":"For NAIS","text":"<ol> <li>Enter the required configuration for <code>azurerator</code> in Fasit, using the information given by the tenant</li> <li>Enable the <code>azurerator</code> feature in Fasit</li> <li>Enable the <code>azurerator</code> feature within <code>naiserator</code> in Fasit</li> </ol>"},{"location":"technical/tenant-setup/addons/digdir/","title":"Digdirator","text":"<p>Digdirator enabled</p> <p>This is an optional addon in NaaS. It is not enabled by default.</p> <p>Digdirator is a feature that integrates with Digdir self-service API. Digdirator enables automated registration and lifecycle management of ID-porten and Maskinporten clients.</p> <p>Before Digdirator can use the self-service API, the tenant must receive administration clients from Digdir, one for each client type, Maskinporten and ID-porten. The Digdir self-service API is secured with oAuth2 using a <code>business certificate</code>.</p> <p>An overview of the setup is as follows:</p> <ul> <li>Clients exist in Digdir and a <code>business certificate</code> is configured</li> <li>Clients are configured with scopes required</li> <li>Add Client ID's to Secret Manager in your project</li> <li>Add <code>business certificate</code> to Google Key Management Service in your project</li> <li>Add business certificate <code>certificate-chain</code> to Secret Manager in your project</li> </ul>"},{"location":"technical/tenant-setup/addons/digdir/#for-tenant","title":"For Tenant","text":""},{"location":"technical/tenant-setup/addons/digdir/#requirements","title":"Requirements","text":""},{"location":"technical/tenant-setup/addons/digdir/#digdir-configuration","title":"Digdir configuration","text":"Recommended configuration for administration clients <p>To secure the integration with Digdir we recommend using a separate certificate for each registered client and that tenants request Digdir to lock each certificate to each client. If you already have a certificate for your clients, you can use that. As setup with these kinds of certificates is not part of this guide, we recommend that you contact Digdir for assistance.</p>"},{"location":"technical/tenant-setup/addons/digdir/#configure-administration-clients-for-id-porten-maskinporten","title":"Configure administration clients for ID-porten &amp; Maskinporten","text":"<ul> <li>ID-porten client is configured with scopes: <code>idporten:dcr.write idporten:dcr.read</code></li> <li>Maskinporten client is configured with scopes: <code>idporten:dcr.write idporten:dcr.read idporten:scopes.write</code></li> <li><code>business certificates</code> are registered in Digdir</li> </ul> <p>Tenant imports the Client ID's to Secret Manager and provide the resource names to NAIS</p> <p><code>projects/&lt;project-id&gt;/secrets/&lt;secret-id&gt;/versions/&lt;version&gt;</code></p> Digdirator use of Client ID <p>Digdirator sets the Client ID as the claim <code>iss</code> when authenticating against Digdir self-service API</p>"},{"location":"technical/tenant-setup/addons/digdir/#nais-configuration","title":"NAIS configuration","text":"<p>We really care about our compadres (tenants) and we think that a separation of concerns is a good &amp; secure way to go. It also helps us to keep the cluster secure and stable. The configuration setup for Digdirator favor security as NAIS never have direct access to your business certificate.</p> <p>When setup in Digdir is confirmed by tenant and before we can enable Digdirator, the following steps must be completed:</p>"},{"location":"technical/tenant-setup/addons/digdir/#business-certificate","title":"Business certificate","text":"Update existing certificate <p>Update of a certificate only requires the tenant to provide NAIS with the new <code>&lt;version&gt;</code></p> <p>The tenant upload their <code>business certificate</code> to Google Cloud KMS. Digdirator will never have direct access to the certificate. Once it is uploaded the business certificate can only be used for cryptographic operations. The business certificate can never be downloaded or retrieved from the KMS storage.</p> <p>An authenticated &amp; authorized Digdirator can only request the <code>Google KMS</code> to sign a payload containing an unsigned token with claims, if successful the KMS returns a signed JWT, this JWT is later used to authenticate against Digdir self-service API.</p> <p>Certificate is successfully uploaded to Google KMS, provide NAIS with the resource names</p> <p><code>projects/&lt;project-id&gt;/locations/&lt;location&gt;/keyRings/&lt;keyring&gt;/cryptoKeys/&lt;key&gt;/cryptoKeyVersions/&lt;version&gt;</code></p>"},{"location":"technical/tenant-setup/addons/digdir/#certificate-chain","title":"Certificate chain","text":"Update existing certificate chain <p>This information unlikely to change, only if a new certificate type is added to the Google KMS. Then the tenant must provide the new resource name or <code>&lt;version&gt;</code> of the certificate chain.</p> <p>Now your probably are wondering why another secret storage we already configured KMS?</p> <p>Well, when authenticating using a <code>buissness certificate</code> the oauth2.0 spec recommends the <code>certificate chain</code> to be present in the token header.</p> <p>The public <code>certificate chain</code> should be set to the <code>x5c</code> (X.509 certificate chain) header parameter, corresponding to the key used to digitally sign the JWS (JSON Web Signature).</p> <p><code>Google Cloud Key Mangement Service</code> is designed as a cryptographic system: nobody, including yourself, can get the keys out: this means they're locked inside the system, and you don't have to worry in practice about them leaking. The tradeoff is that the only thing you can do with those keys is encrypting, decrypt, and other cryptographic operations.</p> <p>But when you do have configuration info like a certificate chain or a client-id, where your software actually needs the secret, not cryptographic operations, then <code>Secret Manager</code> is designed for that use case.</p> <p>Certificate chains is successfully uploaded to <code>Secret Manager</code>, provide NAIS with the resource names</p> <p><code>projects/&lt;project-id&gt;/secrets/&lt;secret-id&gt;/versions/&lt;version&gt;</code></p>"},{"location":"technical/tenant-setup/addons/digdir/#example-format-of-a-certificate-chain","title":"Example format of a certificate chain","text":"<pre><code>-----BEGIN CERTIFICATE-----\nMIIFCDECEBC...\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIE3sKEA...\n-----END CERTIFICATE-----\n-----BEGIN CERTIFICATE-----\nMIIFZTKK...\n-----END CERTIFICATE-----\n</code></pre>"},{"location":"technical/tenant-setup/addons/digdir/#for-nais","title":"For NAIS","text":"<p>When Digdirator is enabled, NAIS configures Digdirator with a service account which holds a set of roles to access Google Cloud KMS and Secret Manager in your cluster project. </p> <p>To access <code>Google KMS</code> the service account is assigned the IAM role <code>roles/cloudkms.signerVerifier</code>, which enables sign, verify, and getPublicKey operations.</p> Google Cloud KMS roles <pre><code>cloudkms.cryptoKeyVersions.useToSign\ncloudkms.cryptoKeyVersions.useToVerify\ncloudkms.cryptoKeyVersions.viewPublicKey\ncloudkms.locations.get\ncloudkms.locations.list\nresourcemanager.projects.get\n</code></pre> <p>To access <code>Secret Manager</code> the service account is assigned the IAM role <code>roles/secretmanager.secretAccessor</code> which allows Digdirator to access the payload of secrets.</p> Google Secret Manager roles <pre><code>secretmanager.secrets.get\nsecretmanager.secrets.access\nresourcemanager.projects.get\n</code></pre> <p>NAIS will configure Digdirator with the information provided, you relax your cognitive load. Configure your NAIS application with ID-porten or Maskinporten, push code -&gt; deploy. NAIS handles the rest.</p> <p>ID-porten sidecar</p> <p>If you plan to use the ID-porten sidecar, prior to usage, the feature Wonderwall must be enabled. Contact NAIS team for more information.</p>"},{"location":"technical/tenant-setup/addons/digdir/#summary-of-nais-configuration","title":"Summary of NAIS configuration","text":"<p>If we were to translate the above information required by NAIS to configure automated lifecycle of Digdir clients. Translated to yaml, it would look something like this</p> <pre><code>maskinporten:\n  kms:\n    key: \"projects/123456789/locations/europe-north1/keyRings/nais-test/cryptoKeys/maskinporten-cert-chain/cryptoKeyVersions/1\"\n  secret-manager:\n    client-id: \"projects/123456789/secrets/maskinporten-client-id/versions/1\"\n    cert-cain: \"projects/123456789/secrets/maskinporten-cert-chain/versions/1\"\nidporten:\n  kms:\n    key: \"projects/123456789/locations/europe-north1/keyRings/nais-test/cryptoKeys/idporten-cert-chain/cryptoKeyVersions/1\"\n  secret-manager:\n    client-id: \"projects/123456789/secrets/idporten-client-id/versions/1\"\n    cert-cain: \"projects/123456789/secrets/idporten-cert-chain/versions/1\"\n</code></pre>"},{"location":"technical/tenant-setup/addons/digdir/#import-certificates","title":"Import Certificates","text":""},{"location":"technical/tenant-setup/addons/digdir/#pre-requisites","title":"Pre-requisites","text":"<p>gcloud CLI is installed and configured with a user that have access to the project.</p> <p>Some configuration can be done in the Google Cloud Console, automatic wrap and import must be done with the <code>gcloud</code> CLI.</p>"},{"location":"technical/tenant-setup/addons/digdir/#google-cloud-kms","title":"Google Cloud KMS","text":"<ol> <li>Create a target key and key ring in your project</li> <li>Create a import job for the target key.</li> <li> <p>Make an import request for key</p> </li> <li> <p>Wrap and import of key can be done in automatically or manually.</p> <ul> <li>Automatically wrap and import   with <code>gcloud</code> CLI</li> <li>Manually is divided into 2 steps<ul> <li>Manually wrap using OpenSSL for Linux or macOS.</li> <li>Manually import in the   Google   Cloud Console or gcloud CLI.</li> </ul> </li> </ul> </li> </ol>"},{"location":"technical/tenant-setup/addons/digdir/#google-secret-manager","title":"Google Secret Manager","text":"<ul> <li>Create a secret in   your project</li> </ul>"},{"location":"technical/tenant-setup/addons/tokenx/","title":"TokenX","text":"<p>TokenX is the short term for the OAuth 2.0 Token Exchange flow implemented in the context of Kubernetes.</p> <p>It primarily exists of:</p> <ul> <li>an OAuth 2.0 Authorization server that provides applications with security tokens in order to securely communicate with each-other in a zero trust architecture.</li> <li>a Kubernetes operator to register OAuth 2.0 clients and associated credentials with said Authorization Server.</li> </ul> <p>The intent of the token exchange flow is to ensure that the original subject's identity and permissions are propagated through a request chain of multiple applications, while maintaining security between each application.</p> <p>This is an optional addon in NaaS. It is not enabled by default.</p>"},{"location":"technical/tenant-setup/addons/tokenx/#for-tenant","title":"For Tenant","text":"<p>Provide the NAIS team with a list of URLs pointing to metadata documents for OAuth 2.0 / OpenID Connect compliant identity providers. This is often referred to as well-known URLs, typically ending in <code>/.well-known/openid-configuration</code> or <code>/.well-known/oauth-authorization-server</code></p> <p>Otherwise, see TokenX for usage.</p>"},{"location":"technical/tenant-setup/addons/tokenx/#for-nais-operators","title":"For NAIS operators","text":"<ol> <li>Enter the tenant-provided well-known URL(s) in the Fasit configuration.<ul> <li>Enter the equivalent hosts for the outbound hosts needed for external access policies.</li> </ul> </li> <li>Generate a set of public/private keypair in JWK format, e.g. through https://mkjwk.org/.<ul> <li>Specifications:<ul> <li>Key Type: RSA</li> <li>Key Size: 2048</li> <li>Key Usage: Signature</li> <li>Algorithm: RS256</li> <li>Key ID: SHA256</li> </ul> </li> <li>The private key is used by Jwker to sign JWT assertions to authenticate itself with Tokendings.</li> <li>The public keyset (JWKS) is used by Tokendings to verify client assertions from Jwker.</li> </ul> </li> <li>Enable Jwker in Naiserator.</li> <li>Enable the TokenX feature.</li> </ol>"},{"location":"technical/tenant-setup/addons/wonderwall/","title":"Wonderwall","text":"<p>Wonderwall is an application that handles OpenID Connect authentication as a sidecar to applications.</p> <p>This is an optional feature that is not enabled by default.</p>"},{"location":"technical/tenant-setup/addons/wonderwall/#for-tenant","title":"For Tenant","text":""},{"location":"technical/tenant-setup/addons/wonderwall/#requirements-and-setup","title":"Requirements and Setup","text":""},{"location":"technical/tenant-setup/addons/wonderwall/#identity-provider","title":"Identity Provider","text":"<p>The tenant must bring its own identity provider.</p> <p>Provide the NAIS team with the well-known URL of the identity provider for each cluster, e.g:</p> <pre><code>https://idp.example.com/.well-known/openid-configuration\n</code></pre> <p>The given identity provider will be the default for all applications in the cluster using Wonderwall.</p>"},{"location":"technical/tenant-setup/addons/wonderwall/#secret","title":"Secret","text":"<p>The tenant must set up a secret for each application that will use Wonderwall. The secret must fulfill the following:</p> <ul> <li>Must be in the same namespace as the application</li> <li>Must follow the naming convention     <pre><code>login-config-&lt;application-name&gt;\n</code></pre></li> <li> <p>Must contain all the following keys:</p> <ul> <li><code>WONDERWALL_OPENID_CLIENT_ID</code> (e.g. <code>my-client-id</code>)</li> </ul> </li> <li> <p>Must contain at least one of the following:</p> <ul> <li><code>WONDERWALL_OPENID_CLIENT_JWK</code> (this is a private key in JWK format, e.g. <code>{\"kty\":\"RSA\",\"e\":\"AQAB\",\"kid\":\"my-key-id\",...}</code>)</li> <li><code>WONDERWALL_OPENID_CLIENT_SECRET</code></li> </ul> </li> </ul> <p>The secret should also contain an annotation that automatically reloads the pod when the data changes:</p> <pre><code>metadata:\n  annotations:\n    reloader.stakater.com/match: \"true\"\n</code></pre> <p>To override the default identity provider configuration, you can set the <code>WONDERWALL_OPENID_WELL_KNOWN_URL</code> key in the same secret.</p>"},{"location":"technical/tenant-setup/addons/wonderwall/#usage-by-applications","title":"Usage by Applications","text":"<p>Configure the application to enable injection of Wonderwall as a sidecar:</p> <pre><code>spec:\n  login:\n    provider: openid\n</code></pre> <p>See the NAIS application reference for the complete specifications with all possible options.</p> <p>Additional documentation:</p> <ul> <li>Technical documentation on GitHub</li> <li>Developer-focused documentation on NAIS</li> </ul> <p>If you've configured <code>WONDERWALL_OPENID_WELL_KNOWN_URL</code>, the application must also allow egress traffic to the matching host:</p> <pre><code>spec:\n  accessPolicy:\n    outbound:\n      external:\n        - host: &lt;identity-provider-host&gt;\n</code></pre>"},{"location":"technical/tenant-setup/addons/wonderwall/#for-nais","title":"For NAIS","text":""},{"location":"technical/tenant-setup/addons/wonderwall/#requirements","title":"Requirements","text":"<ul> <li>Aiven must be enabled for the tenant.</li> </ul>"},{"location":"technical/tenant-setup/addons/wonderwall/#enable-the-wonderwall-feature-flag-in-naiserator","title":"Enable the Wonderwall feature flag in naiserator","text":""},{"location":"technical/tenant-setup/addons/wonderwall/#enable-the-wonderwall-feature-in-fasit","title":"Enable the Wonderwall feature in Fasit","text":"<ul> <li>Configure <code>aiven.redisPlan</code> (e.g. <code>hobbyist</code> for development, <code>startup-4</code> for production)</li> <li>Configure <code>openid.wellKnownUrl</code> provided by the tenant (e.g. <code>https://idp.example.com/.well-known/openid-configuration</code>)</li> <li>Enable <code>openid.enabled</code></li> <li>Finally, enable the feature itself</li> </ul>"},{"location":"welcome/nais-manifest-eng/","title":"NAIS is a AAAA rated platform service","text":"<p>The As represent these qualities:</p> <ul> <li>Autogenous: produced independently of external influence or aid</li> <li>Advantageous: involving or creating favourable circumstances that increase the chances of success or effectiveness.</li> <li>Automatic: working by itself with little or no direct human control.</li> <li>Accountable: required or expected to justify actions or decisions.</li> </ul>"},{"location":"welcome/nais-manifest-eng/#what-is-nais-for","title":"What is NAIS for?","text":"<p>The NAIS platform is there for the development teams, and aims to offer the best conditions for developing quality welfare services for the Norwegian population. We do this by offering solid products that solve real problems at scale. The products are based on technology the nais team believes are technologically sustainable. By using the platform's products and following the platform standards, the teams can focus on solving high value challenges rather than underlying nuts and bolts. The two most important drivers for the further evolution of the platform are technological developments and the needs of the teams.</p>"},{"location":"welcome/nais-manifest-eng/#what-motivates-us","title":"What motivates us?","text":""},{"location":"welcome/nais-manifest-eng/#social-mission","title":"Social mission","text":"<p>We contribute to an important societal mission by developing and maintaining a platform that relieves developers and helps product teams succeed.</p>"},{"location":"welcome/nais-manifest-eng/#colleagues","title":"Colleagues","text":"<p>We have a good working environment with a positive energy consisting of colleagues who have the independence, passion, competence and will needed to solve our mission.</p>"},{"location":"welcome/nais-manifest-eng/#autonomy","title":"Autonomy","text":"<p>We have a great degree of freedom both as individuals and as a team. Within our assignment, we as a team choose which challenges we want to focus on and how we will solve these. As members of the team, we choose which tasks we want to participate in. This gives us a varied day to day life, and ownership of the things we work on.</p>"},{"location":"welcome/nais-manifest-eng/#technology","title":"Technology","text":"<p>At NAIS, we try to always choose the best tool for the job. We have a low threshold for experimentation, and are not afraid to ditch stuff that doesn't work. We take the advice of seasoned adventurers, but at the same time know that we can only make technology choices after building hands-on experience with the alternatives.</p>"},{"location":"welcome/nais-manifest-eng/#what-are-we-optimizing-for","title":"What are we optimizing for?","text":"<ul> <li> <p>Development speed</p> </li> <li> <p>A first class developer experience</p> </li> <li> <p>Easy to build secure applications</p> </li> <li> <p>Easy to operate applications</p> </li> <li> <p>Good ergonomics</p> </li> <li> <p>Keep pace with new technology</p> </li> </ul>"},{"location":"welcome/nais-sponsor/","title":"NAIS-Sponsor","text":""},{"location":"welcome/nais-sponsor/#it-takes-a-village-to-raise-a-nais-developer","title":"It takes a village to raise a NAIS-developer","text":"<p>For your NAIS-specific onboarding you will be guided by not only one sponsor, but you will be attached to the hip of every anchor so that you can gain insight into every as many aspects of NAIS as possible. When you have the general gist of things and feel ready you can just start picking tasks off the board(s).</p> <p>Not only the anchors are your sponsors. Every member of the team is - and you should not be apologetic or hold back in terms of reaching out to \"whomever\" because we have no higher priority than that you settle in and find joy and accomplishment with us. You can also attach yourself to anyone that you feel might shed more light on a topic you want to explore further.</p> <p>So if you find yourself wondering about something - keep this in mind: It is our duty (not to mention in our own best interest) to make sure you have the tools and understanding that you need so imagine that this Cronjob is run on the team every minute. </p>"}]}